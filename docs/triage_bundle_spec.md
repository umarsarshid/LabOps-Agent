# Triage Bundle Spec

This document defines the output bundle generated by `labops run` and the
meaning of each metric currently produced.

## Bundle Layout

Current output files are emitted per run under `<out>/<run_id>/`:

- `scenario.json`: snapshot of the source scenario used for the run.
- `run.json`: run metadata (scenario/backend/seed/timestamps).
- `events.jsonl`: append-only event timeline (one JSON event per line).
- `metrics.csv`: human-friendly metric rows for quick inspection and plotting.
- `metrics.json`: machine-friendly metric object for agent parsing.
- `bundle_manifest.json`: artifact inventory with per-file size and hash.

## Metric Definitions

All metric definitions below are authoritative for current behavior.

### Shared Frame Terms

- `frames_total`: total frame samples returned by backend (received + dropped).
- `received_frames_total`: count of non-dropped frame samples.
- `dropped_frames_total`: count of dropped frame samples.
- `received timestamp`: timestamp of a non-dropped frame sample.

### FPS Metrics

- `avg_fps`
  - Meaning: average received frames per second over the run window.
  - Formula: `received_frames_total / (avg_window_ms / 1000.0)`.
  - Units: frames/second.
  - Notes: dropped frames are not counted in numerator.

- `rolling_fps`
  - Meaning: per-frame rolling FPS over fixed rolling window.
  - Window: `rolling_window_ms` (currently 1000 ms in run flow).
  - Formula per sample:
    - `frames_in_window / (rolling_window_ms / 1000.0)`.
  - Units: frames/second.
  - Sample timestamp:
    - `window_end_ms` equals the received frame timestamp for that sample.
  - Inclusion rule:
    - counts received frames with timestamps in `[window_end - window, window_end]`.

### Drop Metrics

- `drops_total`
  - Meaning: total dropped frame samples.
  - Value source: `dropped_frames_total`.
  - Units: frames.

- `drop_rate_percent`
  - Meaning: percent of total frame samples that were dropped.
  - Formula:
    - if `frames_total > 0`: `(dropped_frames_total * 100.0) / frames_total`
    - else: `0.0`
  - Units: percent.

### Inter-Frame Timing Metrics

These are computed from received frame timestamps sorted in ascending order.

- `inter_frame_interval_*_us`
  - Sample set:
    - consecutive timestamp deltas in microseconds:
      - `interval_i = ts_i - ts_(i-1)` for received frames.
  - `inter_frame_interval_min_us`: minimum interval in sample set.
  - `inter_frame_interval_avg_us`: arithmetic mean interval in sample set.
  - `inter_frame_interval_p95_us`: p95 approximation (nearest-rank method).
  - Units: microseconds.

- `inter_frame_jitter_*_us`
  - Sample set:
    - absolute deviation from mean interval:
      - `jitter_i = abs(interval_i - mean(intervals))`.
  - `inter_frame_jitter_min_us`: minimum jitter value.
  - `inter_frame_jitter_avg_us`: arithmetic mean jitter value.
  - `inter_frame_jitter_p95_us`: p95 approximation (nearest-rank method).
  - Units: microseconds.

### p95 Approximation Rule

Current implementation uses nearest-rank p95 on sorted values:

- `rank = ceil(0.95 * N)`
- `p95 = sorted_values[rank - 1]`

Where `N` is sample count.

## CSV Contract (`metrics.csv`)

Header is fixed:

`metric,window_end_ms,window_ms,frames,fps`

Rows currently emitted:

- `avg_fps,,<avg_window_ms>,<received_frames_total>,<avg_fps>`
- `drops_total,,,<frames_total>,<dropped_frames_total>`
- `drop_rate_percent,,,<frames_total>,<drop_rate_percent>`
- `rolling_fps,<window_end_ms>,<rolling_window_ms>,<frames_in_window>,<fps>`
  - one row per rolling sample
- `inter_frame_interval_min_us,,,<sample_count>,<value>`
- `inter_frame_interval_avg_us,,,<sample_count>,<value>`
- `inter_frame_interval_p95_us,,,<sample_count>,<value>`
- `inter_frame_jitter_min_us,,,<sample_count>,<value>`
- `inter_frame_jitter_avg_us,,,<sample_count>,<value>`
- `inter_frame_jitter_p95_us,,,<sample_count>,<value>`

Formatting:

- numeric values are currently emitted with fixed precision (6 decimals).

## JSON Contract (`metrics.json`)

Top-level fields currently emitted:

- `avg_window_ms`
- `rolling_window_ms`
- `frames_total`
- `received_frames_total`
- `dropped_frames_total`
- `drop_rate_percent`
- `avg_fps`
- `inter_frame_interval_us` object:
  - `sample_count`, `min_us`, `avg_us`, `p95_us`
- `inter_frame_jitter_us` object:
  - `sample_count`, `min_us`, `avg_us`, `p95_us`
- `rolling_fps` array of objects:
  - `window_end_ms`
  - `frames_in_window`
  - `fps`

## Bundle Manifest Contract (`bundle_manifest.json`)

Top-level fields currently emitted:

- `schema_version` (`"1.0"`)
- `hash_algorithm` (`"fnv1a_64"`)
- `files` array of objects:
  - `path` (bundle-relative path)
  - `size_bytes` (file size in bytes)
  - `hash` (hex hash using `hash_algorithm`)

Current run flow includes these files in the manifest:

- `scenario.json`
- `run.json`
- `events.jsonl`
- `metrics.csv`
- `metrics.json`

## Edge Cases

- No frames (`frames_total == 0`)
  - `drop_rate_percent` is `0.0`.
  - `avg_fps` is `0.0` if `received_frames_total == 0`.

- Fewer than 2 received frames
  - no interval/jitter sample set can be formed.
  - corresponding timing/jitter stats remain zero-valued with sample count `0`.

- Dropped frames
  - excluded from FPS and timing interval sample construction.
  - included in drop metrics.
